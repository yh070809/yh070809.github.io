---
layout:     post
title:      Problem when using Kafka / Kafak 中遇到问题
subtitle:   java notes
date:       2020-02-21
author:     Kaiyun
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - Kafak
---
消息中间件的作用 解耦 异步 削峰 
## 遇到的问题

# 重复消费 
重复消费的原因:
消费者在消费消息的时候还没有来的及手动提交(commit 的过程), 消费者就挂了， 这样等到下一次消费的时候， 就又需要重头消费

解决方法 ： 
幂等性
设置主键冲突 
例如 , 设置唯一的订单ID 
使用 Redis设置锁, 利用redis 的原子性


# 消息丢失 
发生原因：
1.发送者发送了一个消息至 leader 的broker, 消费者还没有来得及消费， leader 也没有来得及和follower 同步， 说白了是主从切换中发生的一个问题

2.和消费模式有关系， 有些为了追求快速消费的业务， 在消费端接到消息， 还没有处理业务逻辑的时候， 就commit， 反馈给broker ， 已经收到消息了， 但是如果消费端业务逻辑处理失败， 那么这条消息就丢掉了

解决方法：
1.Kafak API 的参数设置 ：acks 设置， 如果是设置all 表明， 所有节点都同步完了之后才会消费
如果是对消费的信息精确度 比较敏感， 可以这么设置 

2.如果一定要追求消费速度， 可以先将生产者发送过来的数据，存在数据库中，消费端快速commit 至broker , 表示已经收到， 后端线程去数据库读数据并处理业务，同时设定补偿定时任务， 处理没有完成的或者失败的消息


# 消息积压
发生原因： 
例如 秒杀场景， 消息激增， 但是消费者数量不变

解决方法 ： 
最直接 ： 增加消费者 （但不适用于kafka , 在Kafak 中一个分区只能有一个消费者）
对于kafka 来说， 增加分区， 然后将原来的消费者的消费改为转发， 转发至其他的分区 







